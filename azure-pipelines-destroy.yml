trigger: none
pr: none

parameters:
- name: environment
  displayName: "Environment"
  type: string
  default: dev
  values:
    - dev

- name: destroyScope
  displayName: "Destroy Scope"
  type: string
  default: all
  values:
    - all
    - module.vm
    - module.vnet
    - module.subnet
    - module.nsg

variables:
- group: terraform-dev

stages:
# =============================
# STAGE 1: Terraform Destroy Plan
# =============================
- stage: DestroyPlan
  displayName: "Terraform Destroy Plan"
  jobs:
  - job: Plan
    pool:
      name: linux-hosted-agent
    steps:
    - checkout: self

    - task: Bash@3
      displayName: "Terraform Init"
      inputs:
        targetType: inline
        script: |
          cd environments/${{ parameters.environment }}
          terraform init -reconfigure -input=false

    - task: Bash@3
      displayName: "Terraform Destroy Plan"
      inputs:
        targetType: inline
        script: |
          cd environments/${{ parameters.environment }}

          if [ "${{ parameters.destroyScope }}" = "all" ]; then
            terraform plan -destroy -input=false -out=tfdestroy.plan
          else
            terraform plan -destroy \
              -target=${{ parameters.destroyScope }} \
              -input=false \
              -out=tfdestroy.plan
          fi
      env:
        TF_VAR_location: $(TF_VAR_location)
        TF_VAR_rg_name: $(TF_VAR_rg_name)
        TF_VAR_admin_username: $(TF_VAR_admin_username)
        TF_VAR_admin_password: $(TF_VAR_admin_password)

# =============================
# STAGE 2: Manual Approval
# =============================
- stage: Approval
  displayName: "Manual Approval"
  dependsOn: DestroyPlan
  jobs:
  - job: Approval
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: |
          ⚠️ You are about to DESTROY infrastructure.
          
          Environment: ${{ parameters.environment }}
          Scope: ${{ parameters.destroyScope }}

          Please verify carefully.
        onTimeout: reject
        timeoutInMinutes: 60

# =============================
# STAGE 3: Terraform Destroy Apply
# =============================
- stage: DestroyApply
  displayName: "Terraform Destroy Apply"
  dependsOn: Approval
  condition: succeeded()
  jobs:
  - job: Apply
    pool:
      name: linux-hosted-agent
    steps:
    - checkout: self

    - task: Bash@3
      displayName: "Terraform Destroy Apply"
      inputs:
        targetType: inline
        script: |
          cd environments/${{ parameters.environment }}
          terraform init -reconfigure -input=false
          terraform apply -input=false tfdestroy.plan
      env:
        TF_VAR_location: $(TF_VAR_location)
        TF_VAR_rg_name: $(TF_VAR_rg_name)
        TF_VAR_admin_username: $(TF_VAR_admin_username)
        TF_VAR_admin_password: $(TF_VAR_admin_password)

