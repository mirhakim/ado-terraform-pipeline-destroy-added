trigger: none
pr: none

parameters:
- name: environment
  displayName: "Environment"
  type: string
  default: dev
  values:
    - dev

- name: destroyScope
  displayName: "Destroy Scope"
  type: string
  default: all
  values:
    - all
    - module.vm
    - module.vnet
    - module.subnet
    - module.nsg

variables:
- group: terraform-dev

stages:
# =============================
# STAGE 1: Terraform Destroy Plan
# =============================
- stage: DestroyPlan
  displayName: "Terraform Destroy Plan"

  jobs:
  - job: Plan
    pool:
      name: linux-hosted-agent

    steps:
    - checkout: self

    - task: Bash@3
      displayName: "Terraform Init"
      inputs:
        targetType: inline
        script: |
          cd environments/${{ parameters.environment }}
          terraform init -reconfigure -input=false
      env:
        ARM_CLIENT_ID: $(ARM_CLIENT_ID)
        ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
        ARM_TENANT_ID: $(ARM_TENANT_ID)
        ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)

    - task: Bash@3
      displayName: "Terraform Destroy Plan"
      inputs:
        targetType: inline
        script: |
          cd environments/${{ parameters.environment }}

          if [ "${{ parameters.destroyScope }}" = "all" ]; then
            terraform plan -destroy -out=tfdestroy.plan -input=false
          else
            terraform plan -destroy \
              -target=${{ parameters.destroyScope }} \
              -out=tfdestroy.plan -input=false
          fi
      env:
        TF_VAR_location: $(TF_VAR_location)
        TF_VAR_rg_name: $(TF_VAR_rg_name)
        TF_VAR_admin_username: $(TF_VAR_admin_username)
        TF_VAR_admin_password: $(TF_VAR_admin_password)

    - task: PublishPipelineArtifact@1
      displayName: "Publish Destroy Plan"
      inputs:
        targetPath: environments/${{ parameters.environment }}/tfdestroy.plan
        artifact: tfdestroy-plan

# =============================
# STAGE 2: Manual Approval
# =============================
- stage: Approval
  displayName: "Manual Approval"
  dependsOn: DestroyPlan
  jobs:
  - job: Approval
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: |
          ⚠️ You are about to DESTROY infrastructure.
          
          Environment: ${{ parameters.environment }}
          Scope: ${{ parameters.destroyScope }}

          Please verify carefully.
        onTimeout: reject
        timeoutInMinutes: 60

# =============================
# STAGE 3: Terraform Destroy Apply
# =============================
- stage: DestroyApply
  displayName: "Terraform Destroy Apply"
  dependsOn: Approval
  condition: succeeded()

  jobs:
  - job: Apply
    pool:
      name: linux-hosted-agent

    steps:
    - checkout: self

    - task: DownloadPipelineArtifact@2
      displayName: "Download Destroy Plan"
      inputs:
        artifact: tfdestroy-plan
        path: environments/${{ parameters.environment }}

    - task: Bash@3
      displayName: "Terraform Destroy Apply"
      inputs:
        targetType: inline
        script: |
          cd environments/${{ parameters.environment }}

          terraform init -reconfigure -input=false
          terraform apply -auto-approve -input=false tfdestroy.plan
      env:
        ARM_CLIENT_ID: $(ARM_CLIENT_ID)
        ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
        ARM_TENANT_ID: $(ARM_TENANT_ID)
        ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
        TF_VAR_location: $(TF_VAR_location)
        TF_VAR_rg_name: $(TF_VAR_rg_name)
        TF_VAR_admin_username: $(TF_VAR_admin_username)
        TF_VAR_admin_password: $(TF_VAR_admin_password)




